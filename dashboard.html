<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Discord Embed Dashboard</title>
<style>
  body {
    background: #23272a;
    color: #fff;
    font-family: "Segoe UI", Arial, sans-serif;
    margin: 0;
    padding: 0;
  }
  .dashboard-wrapper {
    max-width: 600px;
    margin: 40px auto;
    padding: 32px 16px;
    background: #2c2f33;
    border-radius: 14px;
    box-shadow: 0 4px 32px 0 #0003;
  }
  h1 {
    text-align: left;
    margin-bottom: 28px;
    font-size: 2.3rem;
    font-weight: 800;
    letter-spacing: -1px;
  }
  .form-row {
    margin-bottom: 18px;
  }
  label {
    display: block;
    margin-bottom: 7px;
    font-weight: 600;
    color: #b9bbbe;
  }
  input[type="text"], textarea {
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    border: none;
    background: #23272a;
    color: #fff;
    font-size: 1rem;
    outline: none;
    margin-bottom: 2px;
    box-sizing: border-box;
  }
  textarea {
    resize: vertical;
    min-height: 60px;
    max-width: 100%;
  }
  .color-row {
    display: flex;
    align-items: center;
    gap: 7px;
  }
  .color-row label {
    margin-bottom: 0;
  }
  .hex-color-wrap {
    display: flex;
    align-items: center;
    gap: 3px;
    background: #23272a;
    border-radius: 6px;
    padding: 0 8px;
    height: 35px;
    border: 2px solid #36393f;
    width: 105px;
  }
  .hash-symbol {
    font-weight: 600;
    font-size: 1.1rem;
    color: #b9bbbe;
    user-select: none;
    margin-right: 1px;
  }
  .hex-input {
    width: 65px;
    border: none;
    background: none;
    color: #fff;
    font-size: 1.08rem;
    outline: none;
    padding: 0;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  .hex-input:invalid {
    outline: 2px solid #f04747;
  }
  .color-preview-box {
    width: 25px; height: 25px; border-radius: 4px; margin-left: 9px; border: 1.5px solid #444;
    display: inline-block;
  }
  button, .remove-field-btn {
    background: #5865f2;
    color: white;
    padding: 8px 18px;
    border: none;
    border-radius: 5px;
    font-weight: 600;
    cursor: pointer;
    font-size: 1rem;
    margin-top: 8px;
    margin-bottom: 0;
    transition: background 0.15s;
  }
  button:hover, .remove-field-btn:hover {
    background: #4752c4;
  }
  .fields-header {
    font-size: 1.1rem;
    color: #b9bbbe;
    margin-top: 25px;
    margin-bottom: 5px;
    font-weight: 700;
    letter-spacing: 1px;
  }
  .fields-container {
    margin-bottom: 15px;
  }
  .field {
    background: #36393f;
    padding: 10px;
    border-radius: 7px;
    margin-bottom: 9px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
  }
  .field input[type="text"] {
    width: 40%;
    margin-bottom: 0;
    font-size: 0.98rem;
  }
  .inline-label {
    color: #b9bbbe;
    font-size: 0.97rem;
    margin-left: 7px;
    user-select: none;
  }
  .remove-field-btn {
    background: #f04747;
    padding: 6px 13px;
    border-radius: 5px;
    font-size: 0.97rem;
    margin-left: auto;
    margin-right: 6px;
  }
  /* Podgląd embed */
  .embed-preview-title {
    font-size: 1.15rem;
    font-weight: 700;
    color: #b9bbbe;
    margin-bottom: 13px;
    letter-spacing: 1px;
    text-align: left;
    width: 100%;
  }
  .embed-preview {
    background: #313338;
    border-radius: 9px;
    border-left: 6px solid #5865f2;
    margin-bottom: 16px;
    padding: 18px 23px 15px 20px;
    color: #fff;
    min-height: 90px;
    max-width: 100%;
    box-shadow: 0 1px 9px 0 #1112;
    position: relative;
    min-width: 280px;
    overflow: hidden;
  }
  .ep-title {
    font-weight: 800;
    font-size: 1.19rem;
    margin-bottom: 3px;
    letter-spacing: 0.4px;
  }
  .ep-description {
    font-size: 1.02rem;
    margin-bottom: 9px;
    white-space: pre-line;
    color: #dbdee1;
  }
  .ep-field {
    margin: 11px 0 5px 0;
  }
  .ep-field-name {
    font-weight: 700;
    color: #fff;
    font-size: 1rem;
    margin-bottom: 2px;
  }
  .ep-field-value {
    color: #fff;
    font-size: 0.97rem;
    margin-left: 5px;
  }
  .ep-footer {
    color: #b9bbbe;
    font-size: 0.94rem;
    margin-top: 15px;
    border-top: 1px solid #23272a55;
    padding-top: 6px;
  }
  .ep-image {
    display: block;
    max-width: 130px;
    max-height: 130px;
    border-radius: 6px;
    margin-left: auto;
    margin-top: 7px;
    margin-bottom: 7px;
  }
  /* Upload */
  .image-upload-box {
    margin-top: 13px;
    background: #36393f;
    padding: 12px 9px;
    border-radius: 8px;
    text-align: left;
    max-width: 260px;
  }
  .image-upload-label {
    font-size: 0.97rem;
    color: #b9bbbe;
    font-weight: 500;
    display: block;
    margin-bottom: 5px;
    text-align: left;
  }
  .image-upload-input {
    display: none;
  }
  .image-upload-btn {
    background: #5865f2;
    color: white;
    padding: 7px 17px;
    border: none;
    border-radius: 5px;
    font-weight: 600;
    cursor: pointer;
    font-size: 0.96rem;
    margin-top: 5px;
    margin-bottom: 0;
    transition: background 0.15s;
  }
  .image-upload-btn:hover {
    background: #4752c4;
  }
  .image-upload-preview {
    display: block;
    max-width: 130px;
    max-height: 130px;
    margin: 9px auto 0 auto;
    border-radius: 6px;
    background: #23272a;
    border: 2px solid #444;
  }
  .copy-info {
    color: #43b581;
    margin-top: 7px;
    text-align: left;
    font-size: 1rem;
    font-weight: 600;
    display: none;
  }
</style>
</head>
<body>
<div class="dashboard-wrapper">
  <h1>Discord Embed Builder</h1>
  <div class="form-panel">
    <!-- Dropdown z kanałami -->
    <div class="form-row">
      <label for="channel-select">Channel</label>
      <select id="channel-select">
        <option value="">Loading...</option>
      </select>
      <button id="refresh-channels-btn" style="margin-top:10px;">⟳ Refresh</button>
    </div>
    <div class="form-row">
      <label for="embed-title">Title</label>
      <input type="text" id="embed-title" placeholder="Embed Title" />
    </div>
    <div class="form-row">
      <label for="embed-description">Description</label>
      <textarea id="embed-description" rows="3" placeholder="Write your message here!" style="resize: vertical; min-height:60px; max-width:100%;"></textarea>
    </div>
    <div class="form-row color-row">
      <label>Color:</label>
      <div class="hex-color-wrap">
        <span class="hash-symbol">#</span>
        <input id="hex-input" type="text" maxlength="6" minlength="6" pattern="[0-9A-Fa-f]{6}" class="hex-input" placeholder="5865F2" autocomplete="off" spellcheck="false">
      </div>
      <span class="color-preview-box" id="color-preview-box"></span>
    </div>
    <div class="fields-header">Fields</div>
    <div class="fields-container" id="fields-container"></div>
    <button id="add-field-btn">+ Add Field</button>
    <div class="form-row" style="margin-top:18px;">
      <label for="embed-footer">Footer</label>
      <input type="text" id="embed-footer" placeholder="Footer text" />
    </div>
    <button id="generate-json">Generate & Copy JSON</button>
    <button id="send-embed-btn" style="background:#43b581;">Send Embed</button>
    <button id="edit-embed-btn" style="background:#fca311;">Edit Embed</button>
    <div class="copy-info" id="copy-info">Copied to clipboard!</div>
    <div class="image-upload-box">
      <label class="image-upload-label" for="image-upload-input">Embed image (right):</label>
      <input type="file" id="image-upload-input" class="image-upload-input" accept="image/*" />
      <button class="image-upload-btn" id="upload-btn">Upload Image</button>
      <img id="image-upload-preview" class="image-upload-preview" src="" style="display:none;" />
    </div>
    <!-- Sekcja do pobierania embeda po MessageID -->
    <div class="form-row" style="margin-top:18px;">
      <label>Pobierz embeda do edycji:</label>
      <input type="text" id="load-message-id" placeholder="Message ID" style="width:65%;" />
      <button id="load-embed-btn" style="background:#5865f2;">Load Embed</button>
    </div>
  </div>
  <div style="margin-top:40px;">
    <div class="embed-preview-title">Embed Preview</div>
    <div class="embed-preview" id="embed-preview"></div>
  </div>
</div>
<script>
  // --------- Fields logic ---------
  const fieldsContainer = document.getElementById('fields-container');
  const addFieldBtn = document.getElementById('add-field-btn');
  let fieldCount = 0;

  function createFieldElement(id) {
    const div = document.createElement('div');
    div.classList.add('field');
    div.dataset.fieldId = id;

    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.placeholder = 'Field name';
    nameInput.classList.add('field-name');

    const valueInput = document.createElement('input');
    valueInput.type = 'text';
    valueInput.placeholder = 'Field value';
    valueInput.classList.add('field-value');

    const inlineCheckbox = document.createElement('input');
    inlineCheckbox.type = 'checkbox';
    inlineCheckbox.id = 'inline-'+id;
    inlineCheckbox.style.verticalAlign = 'middle';

    const inlineLabel = document.createElement('label');
    inlineLabel.textContent = 'Inline';
    inlineLabel.className = 'inline-label';
    inlineLabel.htmlFor = 'inline-'+id;

    const removeBtn = document.createElement('button');
    removeBtn.textContent = '✕';
    removeBtn.type = 'button';
    removeBtn.className = 'remove-field-btn';
    removeBtn.onclick = () => div.remove();

    div.appendChild(nameInput);
    div.appendChild(valueInput);
    div.appendChild(inlineCheckbox);
    div.appendChild(inlineLabel);
    div.appendChild(removeBtn);

    return div;
  }

  addFieldBtn.addEventListener('click', () => {
    fieldCount++;
    const fieldEl = createFieldElement(fieldCount);
    fieldsContainer.appendChild(fieldEl);
  });

  // --------- Color HEX logic ---------
  const hexInput = document.getElementById('hex-input');
  const colorPreviewBox = document.getElementById('color-preview-box');
  function setColorBox(val) {
    colorPreviewBox.style.background = /^([0-9A-Fa-f]{6})$/.test(val) ? '#'+val : '#5865F2';
  }
  setColorBox('5865F2');
  hexInput.value = "5865F2";
  hexInput.addEventListener('input', function() {
    setColorBox(hexInput.value);
    updateAll();
  });

  // Wklejanie HEX bez #
  hexInput.addEventListener('paste', e => {
    let text = (e.clipboardData || window.clipboardData).getData('text');
    text = text.replace(/^#/, '').slice(0, 6);
    e.preventDefault();
    document.execCommand('insertText', false, text);
  });

  // --------- Image logic ---------
  let embedImage = "";
  const imageInput = document.getElementById('image-upload-input');
  const uploadBtn = document.getElementById('upload-btn');
  const imagePreview = document.getElementById('image-upload-preview');
  uploadBtn.onclick = () => imageInput.click();
  imageInput.onchange = function(e) {
    if (this.files && this.files[0]) {
      const reader = new FileReader();
      reader.onload = function(ev) {
        embedImage = ev.target.result;
        imagePreview.src = embedImage;
        imagePreview.style.display = 'block';
        updateAll();
      };
      reader.readAsDataURL(this.files[0]);
    }
  };

  // Description resize restriction (vertical only, width maxed)
  document.getElementById('embed-description').style.resize = 'vertical';

  // Auto update preview
  const allInputs = [
    'embed-title','embed-description','hex-input','embed-footer'
  ];
  allInputs.forEach(id => document.getElementById(id).addEventListener('input', updateAll));
  fieldsContainer.addEventListener('input', updateAll);

  // --------- Kopiowanie JSON ---------
  document.getElementById('generate-json').addEventListener('click', function() {
    const json = getEmbedJSON();
    navigator.clipboard.writeText(json).then(() => {
      const info = document.getElementById('copy-info');
      info.style.display = 'block';
      setTimeout(()=>{ info.style.display='none'; }, 1700);
    });
  });

  function getEmbedJSON() {
    const title = document.getElementById('embed-title').value.trim();
    const description = document.getElementById('embed-description').value.trim();
    const hex = hexInput.value.trim().toUpperCase();
    const footerText = document.getElementById('embed-footer').value.trim();

    const fields = [];
    fieldsContainer.querySelectorAll('.field').forEach(fieldDiv => {
      const name = fieldDiv.querySelector('.field-name').value.trim();
      const value = fieldDiv.querySelector('.field-value').value.trim();
      const inline = fieldDiv.querySelector('input[type=checkbox]').checked;
      if(name && value) {
        fields.push({ name, value, inline });
      }
    });

    const embed = {};
    if(title) embed.title = title;
    if(description) embed.description = description;
    if(/^([0-9A-F]{6})$/.test(hex)) embed.color = parseInt(hex,16);
    if(fields.length > 0) embed.fields = fields;
    if(embedImage) embed.image = { url: embedImage };
    if(footerText) embed.footer = { text: footerText };

    return JSON.stringify({ embeds: [embed] }, null, 2);
  }

  // --------- Podgląd embeda ---------
  function updateAll() {
    const preview = document.getElementById('embed-preview');
    preview.innerHTML = '';

    const title = document.getElementById('embed-title').value.trim();
    const description = document.getElementById('embed-description').value.trim();
    const hex = hexInput.value.trim().toUpperCase();
    const footerText = document.getElementById('embed-footer').value.trim();

    // Color bar
    if(/^([0-9A-F]{6})$/.test(hex)) {
      preview.style.borderLeft = '6px solid #' + hex;
    } else {
      preview.style.borderLeft = '6px solid #5865f2';
    }

    if(title) {
      const titleDiv = document.createElement('div');
      titleDiv.className = 'ep-title';
      titleDiv.textContent = title;
      preview.appendChild(titleDiv);
    }

    if(description) {
      const desc = document.createElement('div');
      desc.className = 'ep-description';
      desc.textContent = description;
      preview.appendChild(desc);
    }

    // Fields
    const fields = [];
    fieldsContainer.querySelectorAll('.field').forEach(fieldDiv => {
      const name = fieldDiv.querySelector('.field-name').value.trim();
      const value = fieldDiv.querySelector('.field-value').value.trim();
      const inline = fieldDiv.querySelector('input[type=checkbox]').checked;
      if(name && value) {
        fields.push({ name, value, inline });
      }
    });

    if(fields.length > 0) {
      fields.forEach(f => {
        const fieldDiv = document.createElement('div');
        fieldDiv.className = 'ep-field';
        fieldDiv.style.display = f.inline ? "inline-block" : "block";
        fieldDiv.style.verticalAlign = "top";
        fieldDiv.style.width = f.inline ? "46%" : "100%";
        const nameDiv = document.createElement('div');
        nameDiv.className = 'ep-field-name';
        nameDiv.textContent = f.name;
        const valueDiv = document.createElement('div');
        valueDiv.className = 'ep-field-value';
        valueDiv.textContent = f.value;
        fieldDiv.appendChild(nameDiv);
        fieldDiv.appendChild(valueDiv);
        preview.appendChild(fieldDiv);
      });
    }

    // Embed Thumbnail (right, jak Discord)
    if(embedImage) {
      const img = document.createElement('img');
      img.className = 'ep-thumbnail';
      img.src = embedImage;
      img.style.position = "absolute";
      img.style.top = "18px";
      img.style.right = "18px";
      img.style.width = "70px";
      img.style.height = "70px";
      img.style.objectFit = "cover";
      img.style.borderRadius = "10px";
      img.style.background = "#23272a";
      img.style.border = "2px solid #444";
      preview.appendChild(img);
    }

    // Footer
    if(footerText) {
      const footer = document.createElement('div');
      footer.className = 'ep-footer';
      footer.textContent = footerText;
      preview.appendChild(footer);
    }
  }

  // --------- Nowe: pobieranie kanałów z serwera ---------
  async function fetchChannelList() {
    const select = document.getElementById('channel-select');
    select.innerHTML = '<option value="">Loading...</option>';
    try {
      const res = await fetch('http://localhost:3030/api/list-channels');
      const data = await res.json();
      select.innerHTML = '';
      if (Array.isArray(data) && data.length) {
        data.forEach(ch => {
          const opt = document.createElement('option');
          opt.value = ch.id;
          opt.textContent = `${ch.name} (${ch.id})`;
          select.appendChild(opt);
        });
      } else {
        select.innerHTML = '<option value="">No channels found</option>';
      }
    } catch (e) {
      select.innerHTML = '<option value="">Error loading</option>';
    }
  }
  window.addEventListener('DOMContentLoaded', fetchChannelList);
  document.getElementById('refresh-channels-btn').onclick = fetchChannelList;

  // --------- Wysyłanie embeda do kanału ---------
  document.getElementById('send-embed-btn').onclick = function() {
    const channelId = document.getElementById('channel-select').value;
    if (!channelId) return alert('Wybierz kanał!');
    fetch('http://localhost:3030/api/send-embed', {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        channelId: channelId,
        embed: JSON.parse(getEmbedJSON()).embeds[0]
      })
    }).then(res => res.json())
      .then(data => {
        if(data.messageId) alert("Embed wysłany! Message ID: " + data.messageId);
        else alert("Błąd wysyłania embeda!");
      });
  };

  // --------- Edytowanie embeda ---------
  document.getElementById('edit-embed-btn').onclick = function() {
    const channelId = document.getElementById('channel-select').value;
    if (!channelId) return alert('Wybierz kanał!');
    const messageId = prompt("Podaj Message ID embeda do edycji:");
    if (!messageId) return;
    fetch('http://localhost:3030/api/edit-embed', {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        channelId: channelId,
        messageId: messageId,
        embed: JSON.parse(getEmbedJSON()).embeds[0]
      })
    }).then(res => res.json())
      .then(data => {
        if(data.status === "ok") alert("Embed zaktualizowany!");
        else alert("Błąd edycji embeda!");
      });
  };

  // --------- Pobierz embeda po MessageID i wypełnij formularz ---------
  document.getElementById('load-embed-btn').onclick = async function() {
    const channelId = document.getElementById('channel-select').value;
    const messageId = document.getElementById('load-message-id').value.trim();
    if (!channelId) return alert('Wybierz kanał!');
    if (!messageId) return alert('Podaj Message ID!');
    const res = await fetch('http://localhost:3030/api/get-embed', {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ channelId, messageId })
    });
    const data = await res.json();
    if (data.error || !data.embed) {
      alert('Embed nie znaleziony!');
      return;
    }
    // Załaduj dane embeda do formularza:
    const e = data.embed;
    document.getElementById('embed-title').value = e.title || '';
    document.getElementById('embed-description').value = e.description || '';
    document.getElementById('hex-input').value = e.color ? e.color.toString(16).toUpperCase().padStart(6, "0") : '';
    document.getElementById('embed-footer').value = e.footer?.text || '';
    embedImage = (e.image && e.image.url) ? e.image.url : "";
    document.getElementById('image-upload-preview').src = embedImage;
    document.getElementById('image-upload-preview').style.display = embedImage ? "block" : "none";
    // Fields
    fieldsContainer.innerHTML = "";
    if(Array.isArray(e.fields)){
      e.fields.forEach(f => {
        fieldCount++;
        const fieldEl = createFieldElement(fieldCount);
        fieldEl.querySelector('.field-name').value = f.name || '';
        fieldEl.querySelector('.field-value').value = f.value || '';
        fieldEl.querySelector('input[type=checkbox]').checked = !!f.inline;
        fieldsContainer.appendChild(fieldEl);
      });
    }
    updateAll();
    alert("Embed załadowany!");
  };

  updateAll();
</script>
</body>
</html>